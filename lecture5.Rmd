---
title: "Лекция №5: t-test. хи-квадрат. величина эффекта"
author: "Ольга Ляшевская, Георгий Мороз, Илья Щуров, НИУ ВШЭ"
date: "10 декабря 2015"
output:
  knitrBootstrap::bootstrap_document:
    theme.chooser: FALSE
    highlight.chooser: FALSE
    highlight: Xcode
    menu: FALSE
  toc: true
  toc_depth: 4
---

```{r, echo=F, results='hide'}
Sys.setlocale('LC_ALL',"ru_RU.UTF-8")
set.seed(124)
```
# Лекция №5: t-test. Хи-квадрат. Величина эффекта

*Ольга Ляшевская, Георгий Мороз, Илья Щуров*

Курс «Анализ лингвистических данных: квантитативные методы и визуализация».

Школа лингвистики НИУ ВШЭ, магистерская программа «Теория языка и компьютерная лингвистика», 2015-16 учебный год.

[Школа лингвистики](http://ling.hse.ru/) | [Все материалы курса](http://hsequantling.wikispaces.com/) | [Исходные коды на Github](https://github.com/olesar/hsequantling)

<span style='font-size:80%'>Данный материал доступен под лицензией [CC BY-SA
4.0](https://creativecommons.org/licenses/by-sa/4.0/). При использовании обязательно упоминание авторов курса и аффилиации. При наличии технической возможности необходимо также указать активную гиперссылку на [страницу курса](http://hsequantling.wikispaces.com/).<span>

---

## t-test
Бла-бла.

---

## Независимость двух факторов. Критерий хи-квадрата.
Основная лингвистическая задача, для решения которой используется хи-квадрат, -- это проверка независимости двух факторов. 
Возьмем в качестве примера вариативность в группе с числительном вида *Фермер продал три овцы* / *трех овец*. В первом случае числительное *три* употребляется как неодушевленное и, по правилам русской грамматики, требует после себя существительное в родительном падеже единственного числа. Во втором случае числительное *трех* - одушевленное и употребляется с существительным в родительном падеже множественного числа. Такие количественные группы могут включать и прилагательное (ср. *три белых овцы*, *три белые овцы*, *трех белых овец"), и можно предположить, что этот фактор может влиять на выбор формы количественной группы (*animate* / *inanimate*). 
Сформулируем гипотезу: 
> H1: Выбор признака **animateness** зависит от признака **with_adjective**.

То есть выбор формы (*animate* / *inanimate*) зависит от того, входит в группу прилагательное или нет (ср. *Фермер продал три белых овцы* / *трех белых овец*).

Согласно данным, полученным на корпусной выборке[link ^1^](#fn1), наблюдается такое распределение:

NumP | +adjective | -adjective
------------- | ------------- | -------------
animate | 137 | 451 
inanimate |  15 | 107 

Критерий хи-квадрата позволяет судить, являются ли факторы независимыми, а именно, в нашем случае, зависит ли распределение по признаку одушевленности от распределения по признаку "присутствие прилагательного" и наоборот. Сформулируем нулевую гипотезу: 
> H0: Выбор признака **animateness** никак не зависит от выбора признака **with_adjective**.

Сравним p-value, который выдает функция хи-квадрат, с порогом значимости \alpha (обычно принимается за 0.05 (5%), реже бывает 0.01 или даже 0.001 -- но для лингвистических задач нам всегда будет достаточно порога в 5%). 

```{r eval=TRUE, echo=TRUE}
# создадим таблицу
ch <- matrix(c(137, 15, 451, 107), ncol = 2)
ch
# или, другой способ, создадим таблицу сопряженности из "длинного формата"
x <- read.csv("http://hsequantling.wikispaces.com/file/view/ovtsy.csv/572649397/ovtsy.csv", header=T, sep=";")
ch <- table(x$form, x$adjectives)
# применим функцию хи-квадрата
ch.test <- chisq.test(ch)
ch.test
```

Как видно, p-value = 0.01, что значительно меньше 0.05. Таким образом, вероятность, что мы ошибочно отвергнем нулевую гипотезу, очень мала, и поэтому мы можем смело ее отвергнуть. Значит, основываясь на критерии хи-квадрата, мы заключаем, что форма количественной группы действительно зависит от наличия прилагательного.

### Как это работает

Таблицы, подобные вышеприведенной, называют таблицами сопряженности (cross-table). Здесь у нас у каждой категории два значения (таблица 2 x 2, т.е. две строки и два столбца), но вообще-то их может быть и больше, например, 3 х 5. Для вычисления хи-квадрата сопоставляют **наблюдаемые** и **ожидаемые** частоты. Давайте посмотрим, какова была бы ситуация, если бы признаки не оказывали никакого влияния друг на друга. Мы знаем, что у нас 588 (137 + 451) одушевленных групп и 122 (15 + 107) неодушевленных. И у нас 152 (137 + 15) случая с прилагательными и 558 (451 + 107) - без. Всего у нас 710 наблюдений. Вычислим ожидаемые значения с помощью метода предельных средних (marginal means). Для этого мы перемножаем сумму по строке и сумму по столбцу и полученное делим на общую сумму - и так для каждой ячейки:

NumP | +adjective | -adjective | Total 
------------- | ------------- | ------------- 
animate | = (588 * 152) / 710 | = (588 * 558) / 710 | 588 
inanimate | = (122 * 152) / 710 | = (122 * 558) / 710 | 122 
Total |  152 | 558 | 710 

В R это делается проще:

```{r eval=TRUE, echo=TRUE}
# ch.test <- chisq.test(ch)
ch.test$obs # observed values
ch.test$exp # expected values
```

Итак, мы видим, что в левой верхней ячейке наблюдается больше случаев, чем ожидалось, и то же происходит в правой нижней ячейке. В клетках по другой диагонали - обратная ситуация. Мы можем даже посмотреть, какова разница:
```{r eval=TRUE, echo=TRUE}
# ch.test <- chisq.test(ch)
ch.test$obs-ch.test$exp
```

Однако такое отклонение от ожидаемого - это много или мало? Значение хи-квадрата вычисляется по формуле: <br />
<div style="text-align: center;">
\[\chi^2 = \sum_{}\frac{( observed(i,j) - expected(i,j) )^2}{expected(i,j)},\]</div>
а по каждой ячейке мы можем узнать так называемый "остаток" (residual):
```{r eval=TRUE, echo=TRUE}
ch.test$res # residuals = (observed - expected) / sqrt(expected)
```

Значения хи-квадрата нужно соотнести с критическими значениями в особой таблице, составленной К. Пирсоном, зная количество **степеней свободы** (degrees of freedom). Число степеней свободы рассчитывается как *df* = (*R*−1)(*C*−1), где R и C - количество строк и столбцов в таблице сопряженности. В нашем случае *df* = (2-1)(2-1) = 1. Сейчас, конечно, никто в бумажную таблицу не смотрит, а R вычисляет значения хи-квадрата, *df* и *p-value* автоматически.

Для таблицы 2 x 2 хи-квадрат рассчитывается с **поправкой Йейтса** (поправкой на непрерывность). Причина в том, что распределение самого критерия хи-квадрат является непрерывным, тогда как частоты бинарных признаков (animate / inanimate и т.п.) по определению дискретны.

***
### Когда применять хи-квадрат?
* наблюдения должны быть **независимыми** (поэтому, например, в экспериментальной лингвистике нельзя брать повторяющиеся наблюдения, т.е. полученные от одного и того же респондента, а в корпусной лингвистике рекомендуют не брать примеры из одного текста и даже из одного автора -- поскольку вероятность появления слова в тексте, если оно уже было в нем употреблено, выше). В противном случае см. тест Мак-Немара или Q-критерий Кохрана, а также mixed-effect models.
* данные относятся к **номинальному** (**категориальному**) типу или к **порядковому** типу (шкала)
* при анализе таблицы 2 x 2 **ожидаемые** значения в каждой из ячеек должны быть не менее 10. Если хотя бы в одной ячейке ожидаемое явление принимает значение от 5 до 9, критерий хи-квадрат должен рассчитываться с поправкой Йейтса. Если хотя бы в одной ячейке ожидаемое явление меньше 5, то для анализа должен использоваться точный критерий Фишера.
* если ячеек больше, то ожидаемые значения могут быть меньше 5 не более чем в 20% ячеек.
* в таблице всегда нужно указывать абсолютное число вхождений, а не пропорции/проценты.

***
### Хи-квадрат для большого числа наблюдений. Величина эффекта.
И тут следует сделать важное предупреждение. Чем больше число наблюдений (а в корпусных исследованиях, например, это могут быть тысячи и даже миллионы точек наблюдения), тем чаще критерий хи-квадрата начинает срабатывать некорректно, то есть он показывает p-value, близкий к 0, даже в том случае, если признаки независимы. На уровне здравого смысла это можно объяснить так: чем больше шариков мы будем случайным образом забрасывать в коробку с несколькими ячейками внутри, тем больше вероятность, что их распределение по ячейкам будет неравномерным и наблюдаемое количество шариков в ячейках будет сильно отличаться от математического ожидания. Поэтому значения хи-квадрата дополнительно проверяют одним из методов, оценивающим **величину эффекта**.
Мы будем пользоваться **критерием Крамера** (Cramer's V), который вычисляется по формуле:
<div style="text-align: center;">
\[V = \sqrt{\frac{\chi^2}{N * df'}},\]</div>
где N - общее число наблюдений (сумма всех ячеек таблицы), df' = min(R – 1, C – 1), где R - число строк, C - число столбцов.
Давайте посмотрим, не "врет" ли хи-квадрат в нашем случае.
```{r eval=TRUE, echo=TRUE}
ch.cramersv <- sqrt( ch.test$stat / (sum(ch)*(2-1)) ) # $stat выдает значение хи-квадрата
ch.cramersv
```

V Крамера принимает значения от 0 до 1 и оценивается по таблице, предложенной Дж. Коэном:
df' | малый эффект | средний эффект | большой эффект
1 | 0.1 | 0.3 | 0.5
2 | 0.07 | 0.21 | 0.35
3 | 0.06 | 0.17 | 0.29

В нашем случае V Крамера меньше 0.1, что не позволяет нам отвергнуть нулевую гипотезу.

Возьмем другой пример. А. Голдберг<a href="#fn2">2</a> сравнила употребления дативной и дитранзитивной конструкции с нерегулярными глаголами (у которых наблюдается чередование при образовании форм прош. времени и т.п., ср. *tell*, *give* и т.д.) и регулярными глаголами (ср. explain, present и т. д.). Вот ее даные по корпусу COCA:
Глаголы | Дативная констр.: | Дитранзитивная констр.: 
        | He V the story to me | He V me the story
Регулярные | 567 | 14743
Нерегулярные | 345 | 69

```{r eval=TRUE, echo=TRUE}
# загружаем таблицу сопряженности
ch1 <- matrix(c(567, 345, 14743, 69), ncol = 2)
ch1
# вычисляем хи-квадрат
ch1.test <- chisq.test(ch1)
ch1.test # X-squared = 4663.672, df = 1, p-value < 2.2e-16
# вычисляем V Крамера
ch1.cramer <- sqrt( ch1.test$stat / (sum(ch1)*(2-1)) )
ch1.cramer # 0.5446061 
```

На этот раз все благополучно: значение p-value чрезвычайно близко к 0 (2.2e-16 -- это минимальная величина, которую может вычислить стандартная сборка R), а V Крамера показывает большую величину эффекта. Таким образом, это дает основание Голдберг утверждать, что регулярность образования форм глаголов и выбор конструкции -- два не случайных фактора, т.е. факторы, которые зависят друг от друга.

<a name="fn1"/>
^1^ Данные любезно предоставлены А. Присяжной, см. [link csv](http://hsequantling.wikispaces.com/file/view/ovtsy.csv/572649397/ovtsy.csv)
<a name="fn2"/>
^2^ Goldberg A.E. (2011) Corpus evidence of the viability of statistical preemption. Cognitive linguistics, Vol. 22(1): 131-153.
