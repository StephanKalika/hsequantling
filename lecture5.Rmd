---
title: "Лекция №5: t-test. хи-квадрат. величина эффекта"
author: "Ольга Ляшевская, Георгий Мороз, Илья Щуров, НИУ ВШЭ"
date: "10 декабря 2015"
output:
  knitrBootstrap::bootstrap_document:
    theme.chooser: FALSE
    highlight.chooser: FALSE
    highlight: Xcode
    menu: FALSE
  toc: true
  toc_depth: 4
---

```{r, echo=F, results='hide'}
Sys.setlocale('LC_ALL',"ru_RU.UTF-8")
set.seed(124)
```
# Лекция №5: t-test. Хи-квадрат. Величина эффекта

*Ольга Ляшевская, Георгий Мороз, Илья Щуров*

Курс «Анализ лингвистических данных: квантитативные методы и визуализация».

Школа лингвистики НИУ ВШЭ, магистерская программа «Теория языка и компьютерная лингвистика», 2015-16 учебный год.

[Школа лингвистики](http://ling.hse.ru/) | [Все материалы курса](http://hsequantling.wikispaces.com/) | [Исходные коды на Github](https://github.com/olesar/hsequantling)

<span style='font-size:80%'>Данный материал доступен под лицензией [CC BY-SA
4.0](https://creativecommons.org/licenses/by-sa/4.0/). При использовании обязательно упоминание авторов курса и аффилиации. При наличии технической возможности необходимо также указать активную гиперссылку на [страницу курса](http://hsequantling.wikispaces.com/).<span>

---

## t-test
Бла-бла.

---

## Независимость двух факторов. Критерий хи-квадрата.
Основная лингвистическая задача, для решения которой используется хи-квадрат, -- это проверка независимости двух факторов. 
Возьмем в качестве примера вариативность в группе с числительном вида *Фермер продал три овцы* / *трех овец*. В первом случае числительное *три* употребляется как неодушевленное и, по правилам русской грамматики, требует после себя существительное в родительном падеже единственного числа. Во втором случае числительное *трех* - одушевленное и употребляется с существительным в родительном падеже множественного числа. Такие количественные группы могут включать и прилагательное (ср. *три белых овцы*, *три белые овцы*, *трех белых овец"), и можно предположить, что этот фактор может влиять на выбор формы количественной группы (*animate* / *inanimate*). 
Сформулируем гипотезу: 
> H1: Выбор признака **animateness** зависит от признака **with_adjective**.

То есть выбор формы (*animate* / *inanimate*) зависит от того, входит в группу прилагательное или нет (ср. *Фермер продал три белых овцы* / *трех белых овец*).

Согласно данным, полученным на корпусной выборке[link ^1^](#fn1), наблюдается такое распределение:

NumP | +adjective | -adjective
------------- | ------------- | -------------
animate | 137 | 451 
inanimate |  15 | 107 

Критерий хи-квадрата позволяет судить, являются ли факторы независимыми, а именно, в нашем случае, зависит ли распределение по признаку одушевленности от распределения по признаку "присутствие прилагательного" и наоборот. Сформулируем нулевую гипотезу: 
> H0: Выбор признака **animateness** никак не зависит от выбора признака **with_adjective**.

Сравним p-value, который выдает функция хи-квадрат, с порогом значимости \alpha (обычно принимается за 0.05 (5%), реже бывает 0.01 или даже 0.001 -- но для лингвистических задач нам всегда будет достаточно порога в 5%). 

```{r eval=TRUE, echo=TRUE}
# создадим таблицу
ch <- matrix(c(137, 15, 451, 107), ncol = 2)
ch
# или, другой способ, создадим таблицу сопряженности из "длинного формата"
x <- read.csv("http://hsequantling.wikispaces.com/file/view/ovtsy.csv/572649397/ovtsy.csv", header=T, sep=";")
ch <- table(x$form, x$adjectives)
# применим функцию хи-квадрата
ch.test <- chisq.test(ch)
ch.test
```

Как видно, p-value = 0.01, что значительно меньше 0.05. Таким образом, вероятность, что мы ошибочно отвергнем нулевую гипотезу, очень мала, и поэтому мы можем смело ее отвергнуть. Значит, основываясь на критерии хи-квадрата, мы заключаем, что форма количественной группы действительно зависит от наличия прилагательного.

### Как это работает

Таблицы, подобные вышеприведенной, называют таблицами сопряженности (cross-table). Здесь у нас у каждой категории два значения (таблица 2 x 2, т.е. две строки и два столбца), но вообще-то их может быть и больше, например, 3 х 5. Для вычисления хи-квадрата сопоставляют **наблюдаемые** и **ожидаемые** частоты. Давайте посмотрим, какова была бы ситуация, если бы признаки не оказывали никакого влияния друг на друга. Мы знаем, что у нас 588 (137 + 451) одушевленных групп и 122 (15 + 107) неодушевленных. И у нас 152 (137 + 15) случая с прилагательными и 558 (451 + 107) - без. Всего у нас 710 наблюдений. Вычислим ожидаемые значения с помощью метода предельных средних (marginal means). Для этого мы перемножаем сумму по строке и сумму по столбцу и полученное делим на общую сумму - и так для каждой ячейки:

NumP | +adjective | -adjective | Total 
------------- | ------------- | ------------- 
animate | = (588 * 152) / 710 | = (588 * 558) / 710 | 588 
inanimate | = (122 * 152) / 710 | = (122 * 558) / 710 | 122 
Total |  152 | 558 | 710 

В R это делается проще:

```{r eval=TRUE, echo=TRUE}
# ch.test <- chisq.test(ch)
ch.test$obs # observed values
ch.test$exp # expected values
```

Итак, мы видим, что в левой верхней ячейке наблюдается больше случаев, чем ожидалось, и то же происходит в правой нижней ячейке. В клетках по другой диагонали - обратная ситуация. Мы можем даже посмотреть, какова разница:
```{r eval=TRUE, echo=TRUE}
# ch.test <- chisq.test(ch)
ch.test$obs-ch.test$exp
```

Однако такое отклонение от ожидаемого - это много или мало? Значение хи-квадрата вычисляется по формуле: <br />
<div style="text-align: center;">
\[\chi^2 = \sum_{}\frac{( observed(i,j) - expected(i,j) )^2}{expected(i,j)},\]</div>
а по каждой ячейке мы можем узнать так называемый "остаток" (residual):
```{r eval=TRUE, echo=TRUE}
ch.test$res # residuals = (observed - expected) / sqrt(expected)
```

Значения хи-квадрата нужно соотнести с критическими значениями в особой таблице, составленной К. Пирсоном, зная количество **степеней свободы** (degrees of freedom). Число степеней свободы рассчитывается как *df* = (*R*−1)(*C*−1), где R и C - количество строк и столбцов в таблице сопряженности. В нашем случае *df* = (2-1)(2-1) = 1. Сейчас, конечно, никто в бумажную таблицу не смотрит, а R вычисляет значения хи-квадрата, *df* и *p-value* автоматически.

Для таблицы 2 x 2 хи-квадрат рассчитывается с **поправкой Йейтса** (поправкой на непрерывность). Причина в том, что распределение самого критерия хи-квадрат является непрерывным, тогда как частоты бинарных признаков (animate / inanimate и т.п.) по определению дискретны.

***
### Когда применять хи-квадрат?
* наблюдения должны быть **независимыми** (поэтому, например, в экспериментальной лингвистике нельзя брать повторяющиеся наблюдения, т.е. полученные от одного и того же респондента, а в корпусной лингвистике рекомендуют не брать примеры из одного текста и даже из одного автора -- поскольку вероятность появления слова в тексте, если оно уже было в нем употреблено, выше). В противном случае см. тест Мак-Немара или Q-критерий Кохрана, а также mixed-effect models.
* данные относятся к **номинальному** (**категориальному**) типу или к **порядковому** типу (шкала)
* при анализе таблицы 2 x 2 **ожидаемые** значения в каждой из ячеек должны быть не менее 10. Если хотя бы в одной ячейке ожидаемое явление принимает значение от 5 до 9, критерий хи-квадрат должен рассчитываться с поправкой Йейтса. Если хотя бы в одной ячейке ожидаемое явление меньше 5, то для анализа должен использоваться точный критерий Фишера.
* если ячеек больше, то ожидаемые значения могут быть меньше 5 не более чем в 20% ячеек.
* в таблице всегда нужно указывать абсолютное число вхождений, а не пропорции/проценты.

***
### Хи-квадрат для большого числа наблюдений. Величина эффекта.
И тут следует сделать важное предупреждение. Чем больше число наблюдений (а в корпусных исследованиях, например, это могут быть тысячи и даже миллионы точек наблюдения), тем чаще критерий хи-квадрата начинает срабатывать некорректно, то есть он показывает p-value, близкий к 0, даже в том случае, если признаки независимы. На уровне здравого смысла это можно объяснить так: чем больше шариков мы будем случайным образом забрасывать в коробку с несколькими ячейками внутри, тем больше вероятность, что их распределение по ячейкам будет неравномерным и наблюдаемое количество шариков в ячейках будет сильно отличаться от математического ожидания. Поэтому значения хи-квадрата дополнительно проверяют одним из методов, оценивающим **величину эффекта**.
Мы будем пользоваться **критерием Крамера** (Cramer's V), который вычисляется по формуле:
<div style="text-align: center;">
\[V = \sqrt{\frac{\chi^2}{N * df'}},\]</div>
где N - общее число наблюдений (сумма всех ячеек таблицы), df' = min(R – 1, C – 1), где R - число строк, C - число столбцов.
Давайте посмотрим, не "врет" ли хи-квадрат в нашем случае.
```{r eval=TRUE, echo=TRUE}
ch.cramersv <- sqrt( ch.test$stat / (sum(ch)*(2-1)) ) # $stat выдает значение хи-квадрата
ch.cramersv
```

V Крамера принимает значения от 0 до 1 и оценивается по таблице, предложенной Дж. Коэном:
df' | малый эффект | средний эффект | большой эффект
------------- | ------------- | ------------- | -------------
1 | 0.1 | 0.3 | 0.5
2 | 0.07 | 0.21 | 0.35
3 | 0.06 | 0.17 | 0.29

В нашем случае V Крамера меньше 0.1, что не позволяет нам отвергнуть нулевую гипотезу. Значит, неравномерность распределения данных в таблице можно объяснить случайными влияниями.

Возьмем другой пример. А. Голдберг<a href="#fn2">2</a> сравнила употребления дативной и дитранзитивной конструкции с нерегулярными глаголами (у которых наблюдается чередование при образовании форм прош. времени и т.п., ср. *tell*, *give* и т.д.) и регулярными глаголами (ср. explain, present и т. д.). Вот ее даные по корпусу COCA:
<div>
Глаголы | Дативная констр.: | Дитранзитивная констр.: 
        | He V the story to me | He V me the story
------------- | ------------- | -------------
Регулярные | 567 | 14743
Нерегулярные | 345 | 69
</div>

```{r eval=TRUE, echo=TRUE}
# загружаем таблицу сопряженности
ch1 <- matrix(c(567, 345, 14743, 69), ncol = 2)
ch1
# вычисляем хи-квадрат
ch1.test <- chisq.test(ch1)
ch1.test # X-squared = 4663.672, df = 1, p-value < 2.2e-16
# вычисляем V Крамера
ch1.cramer <- sqrt( ch1.test$stat / (sum(ch1)*(2-1)) )
ch1.cramer # 0.5446061 
```

На этот раз все благополучно: значение p-value чрезвычайно близко к 0 (2.2e-16 -- это минимальная величина, которую может вычислить стандартная сборка R), а V Крамера показывает большую величину эффекта. Таким образом, это дает основание Голдберг утверждать, что регулярность образования форм глаголов и выбор конструкции -- два не случайных фактора, т.е. факторы, которые зависят друг от друга.

*** 
### О другом варианте использования хи-квадрата.
Следует заметить, что хи-квадрат используют еще в одном случае, для проверки того, что наблюдаемое распределение (не) соответствует некоторому априорно заданному. Тут мы наблюдаем распределение между значениями одной категории. 
Например, по даннным снятого корпуса НКРЯ у глагола *падать* наблюдается 202 формы настоящего времени, 240 форм прошедшего времени (в изъявительном наклонении), 41 вхождение инфинитива и 4 вхождения императива. Согласно нашим априорным ожиданиям, у глагола несовершенного вида должно быть в среднем 47% форм настоящего времени, 34% форм прошедшего времени, 17% форм инфинитива и 2% форм императива.
```{r eval=TRUE, echo=TRUE}
chisq.test(c(202,240,41,4), p=c(0.47,0.34,0.17,0.02)) # p-value = 3.448e-13
```
С помощью хи-квадрата мы можем заключить, что распределение форм у этого глагола значимым образом отличается от заданного.

***
### Точный критерий Фишера
Что же делать, если у нас слишком мало точек наблюдения и ожидаемые значения меньше 10? Для таблиц 2 x 2 в этом случае применяют точный критерий Фишера. 
```{r eval=TRUE, echo=TRUE}
# загружаем таблицу сопряженности
ch2 <- matrix(c(2, 10, 8, 4), ncol = 2)
ch2
chisq.test(ch2) # хи-квадрат ругается, что его значения будут некорректными
# вычисляем точный тест Фишера
fisher.test(ch2)
```
Самый известный в современной лингвистике пример применения критерия Фишера - в коллострукционном анализе А. Стефановича и Шт. Гриса. В частности, с его помощью можно выяснить, какие глаголы больше всего "любят" ту или иную конструкцию (или же, наоборот, "не любят"). Составим таблицы сопряженности, подобную той, что мы видели у А. Голдберг, для отдельных глаголов:
<div>
Глагол | Дитранзитивная констр.: | Другие конструкции
------------- | ------------- | -------------
*give* | 461 | 699
другие глаголы | 574 | 136930
</div>
(Данные Stefanowitsch & Gries 2003 по корпусу ICE-GB).
Сформулируем три возможных гипотезы и альтернативную им нулевую гипотезу:

> H1^1: Распределение употреблений глагола X в дитранзитивной конструкции и в других конструкциях отличается от того, что мы видим в среднем по другим глаголам.
> H1^2: Глагол X чаще употребляется в дитранзитивной конструкции, чем в других конструкциях (по сравнению с другими глаголами).
> H1^3: Глагол X реже употребляется в дитранзитивной конструкции, чем в других конструкциях (по сравнению с другими глаголами).
> H0: Распределение употреблений глагола X в дитранзитивной конструкции и в других конструкциях не отличается от того, что мы видим в среднем по другим глаголам.

Для проверки гипотезы H1^1 нам нужно было бы применить стандартный двусторонний тест Фишера, однако в данном случае, поскольку мы знаем, что у глагола *give* наблюдаемых употреблений в дитранзитивной конструкции больше, чем ожидалось, проверим гипотезу H1^2, применив правосторонний тест (опция *greater*).
```{r eval=TRUE, echo=TRUE}
# загружаем таблицу сопряженности
cx <- matrix(c(461, 547, 699, 136930), ncol = 2)
cx
fisher.test(cx, alternative = "greater") # p-value < 2.2e-16
```
P-value близок к нулю, из чего мы можем заключить, что глагол *to give* "очень любит" дитранзитивную конструкцию. Последовательно применив тест Фишера к разным английским глаголам, можно выстроить иерархию притяжения глаголов к интересующей нас конструкции -- достаточно ранжировать их по значениям p-value (а точнее обычно используют -log10(p-value), чтобы лучше различить значения p-value, близкие к нулю).
Если наблюдаемые значения в таблице сопряженности меньше ожидаемых (ср. глагол *to make*), применим левосторонний тест (опция *less*, проверка гипотезы H1^3).
```{r eval=TRUE, echo=FALSE}
f.test <- fisher.test(cx, alternative = "less") # если значение в верхней левой ячейке меньше ожидаемого
f.test$p.value
-log10(f.test$p.value)
```
В результате выстраивается две иерархии: для "притягиваемых" глаголов и для "отталкиваемых" конструкцией глаголов.<br />
Притягиваемые лексемы |  Вхождений |   p-value | -log10(p-value) | | Отталкиваемые лексемы | Вхождений |  p-value | -log10(p-value) 
--------------------- | ---------- | --------- | --------------- | | --------------------- |---------- | -------- | --------------- 
        give          |     461    |         0 |             Inf | |          make         |         3 | 2.72e-04 |         3.56543
        tell          |     128    | 1.60e-127 |       126.79590 | |            do         |        10 | 2.99e-03 |         2.52433
        send          |      64    |  7.26e-68 |        67.13906 | |                       |           |          |                 
        offer         |      43    |  3.31e-49 |        48.48017 | |                       |           |          |                 
        show          |      49    |  2.23e-33 |        32.65170 | |                       |           |          |                 
        cost          |      20    |  1.12e-22 |        21.95078 | |                       |           |          |                 
        teach         |      15    |  4.32e-16 |        15.36452 | |                       |           |          |                 
***
### Что нужно знать о тесте Фишера
* тест непараметрический, то есть не накладывает требований на нормальное распределение данных. Он хорошо подходит к данным, распределенным согласно закону Ципфа, т.е. с большим "хвостом" значений, близких к 0.
* Точный тест Фишера часто применяют к "перекошенным" таблицам, то есть в тех случаях, когда значение в одной клетке (клетках) несопоставимо меньше, чем в других
* тест требует больших вычислительных ресурсов, просчитывая много комбинаций таблиц, и поэтому применяется в основном к таблицам 2 x 2.
* Если точек наблюдения слишком много, R начинает "хитрить", идя на различные аппроксимации, и p-values теста Фишера становятся похожи на p-values хи-квадрата. То же делает Эксель. Поэтому рекомендуется использовать либо онлайн-калькуляторы, работающие на мощных серверах [UCLA](http://www.socr.ucla.edu/htmls/ana/FishersExactTest_Analysis.html), [CSBSJU](http://www.physics.csbsju.edu/stats/exact2.html), [Microsoft](http://research.microsoft.com/en-us/um/redmond/projects/MSCompBio/FisherExactTest), либо воспользоваться пакетом Шт. Гриса для "честного" вычисления теста Фишера в R [здесь](http://www.linguistics.ucsb.edu/faculty/stgries/teaching/groningen/index.html).
* на некоторых онлайн-ресурсах реализован расчет точного критерия Фишера для таблиц 3 x  2 и больше (с использованием различных приближений).

***
### Как устроен точный критерий Фишера?
Чтобы расчитать тест Фишера, нужно понять, сколько других возможных комбинаций чисел в таблице имеет такую же конфигурацию крайних сумм, например, в этой таблице крайние суммы 12, 12, 10 и 14:
Т     |  B | -B | Всего
 A    |  2 |  8 |    10
-A    | 10 |  4	|    14
Всего | 12 | 12	|    24           
Если мы применяем односторонний тест Фишера, мы должны рассчитать, какова вероятность таблиц, у которых левое верхнее значение меньше данного ("less", при сохранении крайних сумм) или больше данного ("greater", аналогично). Например, есть только две таблицы, у которых значение верхней левой ячейки меньше двух:
 Т    |  B | -B | Всего      Т    |  B | -B | Всего
 A    |  1 |  9 |    10      A    |  0 | 10 |    10
-A    | 11 |  3	|    14     -A    | 12 |  2	|    14
Всего | 12 | 12	|    24     Всего | 12 | 12	|    24

При фиксированных суммах по строкам и столбцам вероятность получения наблюдений в первой ячейке подчиняется гипергеометрическому распределению, т.е. это перебор всех вариантов, крайние суммы которых меньше или равны данным:
p = (a+c)!(b+d)!(a+b)!(c+d)! / (a+b+c+d)!a!b!c!d!,
где a,b,c,d - значения в ячейках таблицы, а a+c, b+d, a+b, c+d -- крайние суммы.
Сумма вероятностей данной таблицы и всех возможных таблиц либо с меньшими, либо с большими значениями в первой ячейке дает односторонний вариант теста Фишера. Сумма вероятностей в обе стороны дает двусторонний вариант теста Фишера.

<a name="fn1"></a>
^1^ Данные любезно предоставлены А. Присяжной, см. [link csv](http://hsequantling.wikispaces.com/file/view/ovtsy.csv/572649397/ovtsy.csv)
<br />
<a name="fn2"></a>
^2^ Goldberg A.E. (2011) Corpus evidence of the viability of statistical preemption. Cognitive linguistics, Vol. 22(1): 131-153.
